#!/bin/bash

set -ex

export store_mountpoint="/var/vcap/data"

unprivileged_root_mapping() {
  maximus_uid=$(/var/vcap/packages/garden-idmapper/bin/maximus)
  echo -n "0:${maximus_uid}:1"
}

unprivileged_range_mapping() {
  maximus_uid=$(/var/vcap/packages/garden-idmapper/bin/maximus)
  range="1:1:$((maximus_uid-1))"
  <% if p('garden.experimental_rootless_mode') %>
    range="1:65536:$((maximus_uid-65536))"
  <% end %>
  echo -n $range
}

volume_size() {
  echo "$(( $(df --output=size  $store_mountpoint | sed 1d) * 1024 ))"
}

main() {
  source /var/vcap/jobs/garden/bin/grootfs-utils

  export PATH=/var/vcap/packages/groot-btrfs/bin:/var/vcap/packages/btrfs-progs/bin:$PATH

  local privileged_store_path=${store_mountpoint}/grootfs/store/privileged
  local privileged_volume_file=${store_mountpoint}/grootfs/store/privileged.backing-store
  local privileged_config=/var/vcap/jobs/garden/config/privileged_grootfs_config.yml
  local unprivileged_store_path=${store_mountpoint}/grootfs/store/unprivileged
  local unprivileged_volume_file=${store_mountpoint}/grootfs/store/unprivileged.backing-store
  local unprivileged_config=/var/vcap/jobs/garden/config/grootfs_config.yml

  init_privileged_store $privileged_config
  init_unprivileged_store $unprivileged_config

  drax_setup
}

init_privileged_store() {
  local config_path=$1
  init-store -s $config_path -b $(volume_size)B
}

init_unprivileged_store() {
  local config_path=$1

  init-store -s $config_path -b $(volume_size)B
    -u "$(unprivileged_root_mapping);$(unprivileged_range_mapping)" \
    -g "$(unprivileged_root_mapping);$(unprivileged_range_mapping)"
}

drax_setup() {
  echo "setting up drax..."
  chmod u+s /var/vcap/packages/groot-btrfs/bin/drax
}

main
